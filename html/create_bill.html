<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="Content-Security-Policy" />
        <meta
            http-equiv="X-Content-Security-Policy"
            content="default-src 'self'; script-src 'self'"
        />
        <title>Rechnung</title>
        <link rel="stylesheet" href="../style/create_bill.css" />
    </head>
    <body>
        <h1>Kundeninfos</h1>
        <form id="customerForm" action="">
            <label for="customerName">Kundenname</label>
            <input type="text" id="customerName" name="customerName" />
            <label for="customerStreet"
                >Kundenadresse (Strasse u. Hausnummer)</label
            >
            <input type="text" id="customerStreet" name="customerStreet" />
            <label for="customerCity">Kundenadresse (Stadt u. PLZ)</label>
            <input type="text" id="customerCity" name="customerCity" />
            <label for="paymentLimit">Zahlungsfrist</label>
            <input type="text" id="paymentLimit" name="paymentLimit" />
            <input type="submit" value="Kunden abschliessen" />
        </form>
        <h1>Produkte</h1>
        <div class="products"></div>
        <form id="productForm" action="">
            <label for="productName">Produktname</label>
            <input type="text" id="productName" name="productName" />
            <label for="productPrice">Produktpreis</label>
            <input type="text" id="productPrice" name="productPrice" />
            <label for="productQuantity">Produktmenge</label>
            <input type="text" id="productQuantity" name="productQuantity" />
            <input type="submit" value="Produkt hinzufÃ¼gen" />
        </form>
        <button id="submit">Rechnung erstellen</button>
        <script src="create_bill.js"></script>
        <script>
            window.$ = window.jQuery = require("jquery");
            const fs = require("fs");
            const sqlite = require("sqlite3");
            const db = new sqlite.Database("resources/db.db");
            db.run(
                "CREATE TABLE IF NOT EXISTS bills (id INTEGER PRIMARY KEY AUTOINCREMENT, date TEXT, paymentLimit INTEGER, customerName TEXT, customerPLZ TEXT, customerStreet TEXT, kleinunternehmer BOOLEAN)"
            );
            db.run(
                "CREATE TABLE IF NOT EXISTS products (billId INTEGER PRIMARY KEY, name TEXT, price INTEGER, quantity INTEGER)"
            );
            const companyInfoJson = fs.readFileSync(
                "resources/companyInfo.json",
                "utf8"
            );
            const companyInfo = JSON.parse(companyInfoJson);
            let billInfo = {
                date: new Date().toLocaleDateString(),
                products: [],
            };

            $("#customerForm").submit((e) => {
                e.preventDefault();
                billInfo.customerName = $("#customerName").val();
                billInfo.customerStreet = $("#customerStreet").val();
                billInfo.customerCity = $("#customerCity").val();
                billInfo.paymentLimit = $("#paymentLimit").val();
                $("#customerForm").hide();
                $("#productForm").show();
            });
            $("#productForm").submit((e) => {
                e.preventDefault();
                let product = {
                    name: $("#productName").val(),
                    price: $("#productPrice").val(),
                    quantity: $("#productQuantity").val(),
                };
                billInfo.products.push(product);
                $(".products").append(
                    `<div class="product"><div class="name">${product.name}</div><div class="price">${product.price}</div><div class="quantity">${product.quantity}</div></div>`
                );
                $("#productForm")[0].reset();
            });
            $("#submit").click(async () => {
                db.run(
                    "INSERT INTO bills (date, paymentLimit, customerName, customerPLZ, customerStreet, kleinunternehmer) VALUES (?, ?, ?, ?, ?, ?)",
                    [
                        billInfo.date,
                        billInfo.paymentLimit,
                        billInfo.customerName,
                        billInfo.customerCity,
                        billInfo.customerStreet,
                        companyInfo.kleinunternehmer,
                    ],
                    (err) => {
                        if (err) {
                            console.log(err);
                        }
                    }
                );
                db.each("SELECT last_insert_rowid();", (e, j) => {
                    billInfo.id = j["last_insert_rowid()"];
                    billInfo.products.forEach((product) => {
                        db.run(
                            "INSERT INTO products (billId, name, price, quantity) VALUES (?, ?, ?, ?)",
                            [
                                billInfo.id,
                                product.name,
                                product.price,
                                product.quantity,
                            ]
                        );
                    });
                    create_bill(billInfo, companyInfo);
                });
            });
        </script>
    </body>
</html>
